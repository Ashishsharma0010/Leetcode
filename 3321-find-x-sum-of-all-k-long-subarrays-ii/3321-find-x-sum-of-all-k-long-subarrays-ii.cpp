 class Solution {
    public:
 
 vector<long long> findXSum(vector<int>& nums, int k, int x) {
            int n = nums.size();
                    vector<long long> ans(n - k + 1);
                            unordered_map<int,int> cnt;
                                    auto cmp = [](const pair<int,int>& a, const pair<int,int>& b) {
                                                if (a.first != b.first) return a.first < b.first;
                                                            return a.second < b.second;
                                                                    };
                                                                            multiset<pair<int,int>, decltype(cmp)> topSet(cmp), botSet(cmp);
                                                                                    long long sumTop = 0;
                                                                                            auto insertElem = [&](int val) {
                                                                                                        int f = cnt[val];
                                                                                                                    pair<int,int> p = {f, val};
                                                                                                                                if ((int)topSet.size() < x) {
                                                                                                                                                if (!botSet.empty()) {
                                                                                                                                                                    auto itb = prev(botSet.end());
                                                                                                                                                                                        if (cmp(p, *itb)) {
                                                                                                                                                                                                                topSet.insert(*itb);
                                                                                                                                                                                                                                        sumTop += 1LL * itb->first * itb->second;
                                                                                                                                                                                                                                                                botSet.erase(itb);
                                                                                                                                                                                                                                                                                        botSet.insert(p);
                                                                                                                                                                                                                                                                                                                return;
                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                    topSet.insert(p);
                                                                                                                                                                                                                                                                                                                                                                                    sumTop += 1LL * f * val;
                                                                                                                                                                                                                                                                                                                                                                                                } else {
                                                                                                                                                                                                                                                                                                                                                                                                                auto it = topSet.begin();
                                                                                                                                                                                                                                                                                                                                                                                                                                if (it != topSet.end() && cmp(*it, p)) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                    pair<int,int> q = *it;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        topSet.erase(it);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            sumTop -= 1LL * q.first * q.second;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                botSet.insert(q);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    topSet.insert(p);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        sumTop += 1LL * f * val;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        } else botSet.insert(p);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            };
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    auto removeElem = [&](int val, int oldFreq) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                pair<int,int> p = {oldFreq, val};
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            auto it = topSet.find(p);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if (it != topSet.end()) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        sumTop -= 1LL * oldFreq * val;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        topSet.erase(it);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    } else {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    auto it2 = botSet.find(p);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if (it2 != botSet.end()) botSet.erase(it2);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        };
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                auto rebalance = [&]() {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            int distinct = cnt.size();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        int need = min(x, distinct);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    while ((int)topSet.size() < need && !botSet.empty()) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    auto it = prev(botSet.end());
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    auto p = *it;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    botSet.erase(it);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    topSet.insert(p);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    sumTop += 1LL * p.first * p.second;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            while ((int)topSet.size() > need) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            auto it = topSet.begin();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            auto p = *it;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            topSet.erase(it);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            sumTop -= 1LL * p.first * p.second;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            botSet.insert(p);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                };
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        for (int i = 0; i < k; i++) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    int v = nums[i];
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                int oldF = cnt[v];
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if (oldF > 0) removeElem(v, oldF);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        cnt[v]++;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    insertElem(v);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    rebalance();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            ans[0] = sumTop;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    for (int i = k; i < n; i++) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                int outVal = nums[i - k];
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            int oldF = cnt[outVal];
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        removeElem(outVal, oldF);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if (oldF == 1) cnt.erase(outVal);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                else {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                cnt[outVal] = oldF - 1;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                insertElem(outVal);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        int inVal = nums[i];
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    int oldF2 = cnt[inVal];
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if (oldF2 > 0) removeElem(inVal, oldF2);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            cnt[inVal] = oldF2 + 1;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        insertElem(inVal);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    rebalance();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                ans[i - k + 1] = sumTop;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                return ans;
                                                                                                                    }
                                                                                                                                                                                                                                                                                                };                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    